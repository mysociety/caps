{% extends "scoring/base.html" %}
{% load django_bootstrap5 %}

{% block content %}
<div class="pt-5 pb-6 pt-lg-8 pb-lg-8 hero-section with-version-background">
    <div class="d-flex flex-column align-items-end align-items-lg-start hero-version-badge position-absolute">
        <span class="version-year d-block fw-bold lh-1">2023</span>
        <span class="version-name d-block fw-bold lh-1">Action Scorecards</span>
    </div>
    <div class="container">
        <h2 class="fs-4">Actions Scorecards 2023</h2>
        <h1 class="mb-2">{{ section.description }}</h1>
        {% comment %} TODO section description {% endcomment %}
        <div class="row mt-3">
            <div class="col-lg-6">
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            </div>
        </div>
    </div>
</div>

{% if not section.is_combined %}
<div class="container pt-5 pt-lg-6">
  <h3 class="mb-4">Section overview</h3>
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-3 g-4">
        <div class="col">
            <a href="#" class="card text-decoration-none text-black h-100">
                <div class="card-header py-3 text-bg-primary">
                    <h3 class="fs-5 mb-0 lh-base text-center">
                        Single Tier
                    </h3>
                </div>
                <div class="card-body d-flex flex-column align-items-center">
                    <span class="fs-1 lh-0">{{ averages.single.average|floatformat:0 }}/{{ averages.single.maximum }}</span>
                    <span>Average</span>
                </div>
            </a>
        </div>

        <div class="col">
            <a href="#" class="card text-decoration-none text-black h-100">
                <div class="card-header py-3 text-bg-primary">
                    <h3 class="fs-5 mb-0 lh-base text-center">
                        District
                    </h3>
                </div>
                <div class="card-body d-flex flex-column align-items-center">
                    <span class="fs-1 lh-0">{{ averages.district.average|floatformat:0 }}/{{ averages.district.maximum }}</span>
                    <span>Average</span>
                </div>
            </a>
        </div>

        <div class="col">
            <a href="#" class="card text-decoration-none text-black h-100">
                <div class="card-header py-3 text-bg-primary">
                    <h3 class="fs-5 mb-0 lh-base text-center">
                        County
                    </h3>
                </div>
                <div class="card-body d-flex flex-column align-items-center">
                    <span class="fs-1 lh-0">{{ averages.county.average|floatformat:0 }}/{{ averages.county.maximum }}</span>
                    <span>Average</span>
                </div>
            </a>
        </div>

        <div class="col">
            <a href="#" class="card text-decoration-none text-black h-100">
                <div class="card-header py-3 text-bg-primary">
                    <h3 class="fs-5 mb-0 lh-base text-center">
                        Northern Ireland
                    </h3>
                </div>
                <div class="card-body d-flex flex-column align-items-center">
                    <span class="fs-1 lh-0">{{ averages.ni.average|floatformat:0 }}/{{ averages.ni.maximum }}</span>
                    <span>Average</span>
                </div>
            </a>
        </div>


        {% if alternative %}
        <div class="col">
            <div href="#" class="card text-decoration-none text-black h-100">
                <div class="card-header py-3 text-bg-primary">
                    <h3 class="fs-5 mb-0 lh-base text-center">
                        Combined Authority
                    </h3>
                </div>
                <div class="card-body alert alert-info mb-0">
                    <p class="mb-2 fs-7">This section does not apply to combined authority councils. Visit the following section instead:</p>
                    <a href="{{ alternative.url }}" class="alert-link">{{ alternative.name }}</a>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col">
          <div href="#" class="card text-decoration-none text-black h-100">
              <div class="card-header py-3 text-bg-primary">
                  <h3 class="fs-5 mb-0 lh-base text-center">
                      Combined Authority
                  </h3>
              </div>
              <div class="card-body alert alert-info mb-0">
                  <p class="mb-2 fs-7">This section does not apply to combined authority councils.</p>
                  <p class="mb-2 fs-7">Currently there is not an equivalent section.</p>
              </div>
          </div>
        </div>
        {% endif %}

    </div>
</div>

{% elif section.is_combined %}
<div class="container pt-5 pt-lg-6">
  <h3 class="mb-4">Section overview</h3>
    <div class="row">
        <div class="col-lg-4">
            <a href="#" class="card text-decoration-none text-black h-100">
                <div class="card-header py-3 text-bg-primary">
                    <h3 class="fs-5 mb-0 lh-base text-center">
                      Combined Authority
                    </h3>
                </div>
                <div class="card-body d-flex flex-column align-items-center">
                    <span class="fs-1 lh-0">{{ averages.combined.average|floatformat:0 }}/{{ averages.combined.maximum }}</span>
                    <span>Average</span>
                </div>
            </a>
        </div>
    </div>
  
    <div class="row mt-3">
      <div class="col-lg-4">
        <div class="alert alert-info">
          <p>This section only apply to Combined Authority. For all the other type of councils you can visit the following equivalent sections:</p>
          <div class="d-flex flex-column gap-1">
            <a href="{{ alternative.url }}" class="alert-link">{{ alternative.name }}</a>
          </div>
        </div>
      </div>
    </div>
</div>
{% endif %}

<div class="container pt-5 pt-lg-6">
    <h3 class="mb-4">Section information</h3>
    <div class="row">
        <div class="col-lg-6">
            <div class="accordion" id="accordionAboutSections">
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingOne">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                      About the scoring
                    </button>
                  </h2>
                  <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#accordionAboutSections">
                    <div class="accordion-body">
                      <strong>This is the first item's accordion body.</strong> It is shown by default, until the collapse plugin adds the appropriate classes that we use to style each element. These classes control the overall appearance, as well as the showing and hiding via CSS transitions. You can modify any of this with custom CSS or overriding our default variables. It's also worth noting that just about any HTML can go within the <code>.accordion-body</code>, though the transition does limit overflow.
                    </div>
                  </div>
                </div>
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingTwo">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                      Accordion Item #2
                    </button>
                  </h2>
                  <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionAboutSections">
                    <div class="accordion-body">
                      <strong>This is the second item's accordion body.</strong> It is hidden by default, until the collapse plugin adds the appropriate classes that we use to style each element. These classes control the overall appearance, as well as the showing and hiding via CSS transitions. You can modify any of this with custom CSS or overriding our default variables. It's also worth noting that just about any HTML can go within the <code>.accordion-body</code>, though the transition does limit overflow.
                    </div>
                  </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container pt-5 pt-lg-6 js-dynamic-content">
    <h3 class="mb-4">Section list of questions</h3>
    <div class="row">
        <div class="col-lg-6">
            <div class="bg-primary-100 p-3 mb-4 border rounded">
                <label for="questions-council-name" class="d-block mb-2">Show questions for a specific council</label>
                <input class="form-control searchbar js-methodology-council-autocomplete" type="search" placeholder="Council name" aria-label="Council name" id="questions-council-name">
                <p class="mt-3 mt-lg-4 mb-2">Or show questions by type of council</p>
                <div class="d-flex flex-wrap gap-1">
                    <button class="btn btn-outline-primary btn-sm is--with-label" data-methodology-switch-council-type="single" data-bs-toggle="tooltip" data-bs-placement="top"
                    data-bs-custom-class="custom-tooltip"
                    data-bs-title="This includes all London, Welsh and Scottish councils as well as Metropolitan Borough Councils and Unitary Councils.">
                        <span><a href="{% url 'scoring:section' section.code %}?type=single" class="text-decoration-none">Single Tier</a></span>
                        {% include 'caps/icons/question-circle.html' with classes='ms-1 align-text-top' width='1.1rem' height='1.1rem' role='presentation' %}
                    </button>
                    <button class="btn btn-outline-primary btn-sm is--with-label" data-methodology-switch-council-type="district"><a href="{% url 'scoring:section' section.code %}?type=district" class="text-decoration-none">District</a></button>
                    <button class="btn btn-outline-primary btn-sm is--with-label" data-methodology-switch-council-type="county"><a href="{% url 'scoring:section' section.code %}?type=county" class="text-decoration-none">County</a></button>
                    <button class="btn btn-outline-primary btn-sm is--with-label" data-methodology-switch-council-type="northern-ireland"><a href="{% url 'scoring:section' section.code %}?type=northern-ireland" class="text-decoration-none">Northern Ireland</a></button>
                </div>
            </div>
        </div>
    </div>

    <div class="row d-none d-md-flex">
      <div class="col-lg-6">
        <div class="accordion" id="accordionCouncilsComparisson">
          <div class="accordion-item">
            <h2 class="accordion-header" id="CouncilsComparissonheadingTwo">
              <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#CouncilsComparissoncollapseTwo" aria-expanded="false" aria-controls="CouncilsComparissoncollapseTwo">
                Add councils to compare
              </button>
            </h2>
            <div id="CouncilsComparissoncollapseTwo" class="accordion-collapse collapse show" aria-labelledby="CouncilsComparissonheadingTwo" data-bs-parent="#accordionCouncilsComparisson">
              <div class="accordion-body">
                <div class="mobile-message d-sm-none p-3 text-bg-secondary">
                  <h3 class="exclamation text-white">Visit us again on a bigger screen</h3>
                  <p class="text-white">You’ll find more options, like the ability to compare your council’s Scorecard with other councils, and see a more granular breakdown of how they did on each question of the Scorecards.</p>
                </div>
                <div class="d-none d-lg-block">
                  <form class="d-none d-lg-block" id="advancedFilterForm" action=".">
                    {% if comparison_councils|length > 2 %}
                    <p class="warning-message">You have reached the maximum number of councils that may be compared.</p>
                  {% else %}
                    <input class="border border-primary form-control searchbar blue dark js-location-compare-autocomplete" name="search" id="compare-search" type="search" placeholder="Council name" aria-label="Council name">
                  {% endif %}
                  {% if comparison_councils %}
                    <div class="selected-council-wrapper mt-4">
                      {% for comparison in comparison_councils %}
                        <a href="{% url 'scoring:council' comparison.council.slug %}" class="radio-btn is--with-label is--with-closed-icon mr-1 js-comparison-council" data-slug="{{ comparison.council.slug }}">{{ comparison.council.name }}</a>
                      {% endfor %}
                    </div>
                    <a href="{% url 'scoring:section' section.code %}" class="mt-3">Clear all</a>
                  {% endif %}
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% if council_type %}
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4 mt-4">
    {% if comparison_scores %}
    {% for comparison in comparison_scores %}
      <div class="col">
          <a href="{% url 'scoring:council' comparison.council_slug %}" class="card text-decoration-none text-black h-100">
            <div class="card-header py-3 text-bg-primary">
                <h3 class="fs-5 mb-0 lh-base text-center">
                    {{ comparison.council_name }}
                </h3>
            </div>
            <div class="card-body d-flex flex-column align-items-center">
                <span class="fs-1 lh-0">{{ comparison.score }}/{{ comparison.max_score }}</span>
                {% if comparison.negative_points < 0 %}
                <div class="fs-7 d-none">
                    {{ comparison.score }} = Total score({{ comparison.non_negative_max }}) - Penalty points({{ comparison.negative_points }})
                </div>
                {% endif %}
            </div>
            {% if comparison.negative_points < 0 %}
            <p class="alert alert-warning d-flex flex-row align-items-center gap-2 p-2 mb-0 rounded-0 border-0">
              {% include 'caps/icons/warning.html' with classes='align-text-bottom' width='1em' height='1em' role='presentation' %}
              <span class="fs-7">
                  {{ comparison.council_name }} has a penalty of {{ comparison.negative_percent }}% in this section
              </span>
            </p>
            {% endif %}
        </a>
    </div>
    {% endfor %}
    {% endif %}

    <div class="col">
      <a href="#" class="card text-decoration-none text-black h-100">
          <div class="card-header py-3 text-bg-primary">
              <h3 class="fs-5 mb-0 lh-base text-center">
                {{ council_type.name|title }}
              </h3>
          </div>
          <div class="card-body d-flex flex-column align-items-center">
              <span class="fs-1 lh-0">{{ council_type_avg.average|floatformat:0 }}/{{ council_type_avg.maximum }}</span>
              <span>Average</span>
          </div>
      </a>
    </div>
  </div>

    <div class="row mb-5 mt-4">
      <div class="col-12">
        <div class="position-relative" style="display: table">
            <table class="section-question-table mb-0">
                <thead class="text-bg-primary position-sticky z-index-3 top-0">
                    <tr class="d-none d-md-table-row">
                        <th scope="col" class="text-start question-header-cell border-end border-opacity-25 border-primary">Questions</th>

                        {% for comparison in comparison_councils %}
                        <th scope="col">
                            <p class="mb-1">{{ comparison.council.name }}</p>
                            <a class="fs-7 link-light fw-normal" href="{% url 'scoring:council' comparison.council.slug %}">Go to council scorecard</a>
                        </th>
                        {% endfor %}

                        <th scope="col" class="d-flex flex-column">
                            <span class="mb-1">{{ council_type.name|title }}</span>
                          <span class="fw-normal fs-7">Average</span>
                        </th>
                    </tr class="d-md-table-row">
                </thead>

                <tbody class="table-question-council__section border">

                    {% for question in questions %}
                    <tr class="question-row d-flex flex-column d-md-table-row border-bottom">
                      <td data-column="answer" class="border-end">

                          <div class="question-content-table text-start">
                            <div class="row">
                              <div class="col-md-1">
                                <span class="badge bg-secondary p-1 question-no">
                                  {{ question.details.pretty_code }}
                                </span>
                              </div>
                              <div class="col-md-11">
                                <div class="js-collapse-children">
                                  Has the council committed to building all future council owned or managed housing to a high energy efficiency or operationally net-zero standard?
                                </div>

                                {% if question.details.question_type == 'negative' %}
                                <div class="d-flex flex-nowrap my-3 fs-7 text-red-500">
                                  {% include 'caps/icons/warning.html' with classes='mt-1 me-2 flex-shrink-0 flex-grow-0' width='1em' height='1em' role='presentation' %}
                                  <p class="mb-0">
                                      <strong>Negative points:</strong>
                                      The maximum number of points for this question is 0.
                                      {% comment %} TODO add link to this question in methodology {% endcomment %}
                                      <a href="{% url 'scoring:methodology' %}#todo" style="color: inherit;">Read more about negative point questions.</a>
                                  </p>
                                </div>
                                {% endif %}

                                <button class="btn btn-outline-secondary btn-sm js-hidden-toggle" aria-controls="how-section-{{ forloop.parentloop.counter }}-question-{{ forloop.counter }}">How this is marked</button>

                                <div class="text-muted fs-7" id="how-section-{{ forloop.parentloop.counter }}-question-{{ forloop.counter }}">
                                    <dl class="row mt-2 mb-0">
                                        <dt class="col-sm-4">Source</dt>
                                        <dd class="col-sm-8">{{ question.details.get_how_marked_display }}</dd>
                                        <dt class="col-sm-4">Question weight</dt>
                                        <dd class="col-sm-8">{{ question.details.get_weighting_display }}</dd>
                                        <dt class="col-sm-4">Evidence</dt>
                                        <dd class="col-sm-8">
                                            {% for link in answer.evidence_links %}
                                            <a href="{{ link }}" style="display: block;overflow: hidden;text-overflow: ellipsis;white-space: nowrap;">{{ link }}</a>
                                            {% empty %}
                                            No evidence available.
                                            {% endfor %}
                                        </dd>
                                    </dl>
                                </div>
    
                                {% comment %} TODO Include evidence if we are currently viewing a council {% endcomment %}
                                <button type="button" class="btn btn-outline-secondary btn-sm d-block mt-3" data-bs-toggle="modal" data-bs-target="#section-{{ forloop.parentloop.counter }}-question-{{ forloop.counter }}">
                                  View criteria
                                </button>
    
                                <div class="modal fade" id="section-{{ forloop.parentloop.counter }}-question-{{ forloop.counter }}" tabindex="-1" aria-labelledby="section-{{ forloop.parentloop.counter }}-question-{{ forloop.counter }}Label" aria-hidden="true">
                                    <div class="modal-dialog">
                                      <div class="modal-content">
                                        <div class="modal-header">
                                          <h5 class="modal-title" id="section-{{ forloop.parentloop.counter }}-question-{{ forloop.counter }}Label">
                                            <p>Criteria</p>
                                            <div class="fw-normal fs-7">{{ answer.details.text | linebreaks }}</div>
                                          </h5>
                                        </div>
                                        <div class="modal-body">
                                          {{ question.details.criteria|linebreaks }}
                                        </div>
                                        <div class="modal-footer">
                                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                </div>

                              </div>

                            </div>
                          </div>
                      </td>

                      {% for comparison in question.comparisons %}
                      {% comment %} On mobile we will display only the average for the type of council. {% endcomment %}
                      <td data-column="score" class="text-start text-md-end d-flex flex-row d-md-table-cell score">
                        <span class="me-2">{{ comparison.score }}/{{ question.details.max_score }}</span>
                        <span class="badge bg-secondary d-md-none">{{ comparison.council_name }}</span>
                          {% comment %} TODO IF question is negative then "No negative points awarded" {% endcomment %}
                      </td>
                      {% endfor %}

                      <td data-column="score" class="text-start text-md-end d-flex flex-row d-md-table-cell score">
                        <span class="me-2">{{ question.average }}/{{ question.details.max_score }}</span>
                        <span class="badge bg-secondary d-md-none">{{ council_type.name|title }} Council</span>
                      </td>
                    </tr>
                   {% endfor %}

                </tbody>

            </table>
        </div>
      </div>
      {% endif %}
    </div>
</div>

{% endblock %}
