{% extends "scoring/base.html" %}

{% load static %}
{% load django_bootstrap5 %}

{% block content %}
    {% include 'scoring/includes/home-announcement.html' %}

    <div class="py-5 py-md-6 hero-section with-version-background">
        <div class="container">
            <h1 class="mb-3">
                <p class="version-year d-block display-1 lh-1 fw-bold mb-0" style="mix-blend-mode: overlay">{{ plan_year }}</p>
                Action Scorecards
            </h1>
            <p class="mb-4" style="max-width: 650px;">Climate Emergency UK assessed all UK councils on the actions they've taken towards net zero. The Scorecard assessment consists of 91 questions or less, depending on council type, across 7 different sections, created in consultation with over 90 different organisations and individuals. Each council was marked against these criteria and given a right to reply before the scores underwent a final audit. This work was completed between January and August 2023.  
            </p>
            <a class="btn btn-outline-primary me-3 mb-3" href="{% url 'year_scoring:methodology' plan_year %}"> Learn more about the methodology</a>
            {% if current_plan_year %}
                <a href="{% url 'scoring:sections' %}" class="btn btn-outline-primary mb-3">Go to sections</a>
            {% else %}
                <a href="{% url 'year_scoring:sections' plan_year %}" class="btn btn-outline-primary mb-3">Go to sections</a>
            {% endif %}
        </div>
    </div>

    <div class="container home pt-5">
        <div class="row">
            <div class="mb-3 mb-lg-0 col-12">
                <h3 class="fs-6 mb-3 lh-1">Load a Scorecard by council type</h3>
                {% include 'scoring/includes/main-filter.html' %}
            </div>
        </div>

        <div class="my-3 my-lg-5 mx-lg-auto position-relative">
            <div class="bg-gray-200 px-3 py-2 border d-none d-lg-block">
                {% include 'scoring/includes/jump-to-council.html' %}
            </div>

            <div class="scorecard-table-wrapper border border-top-0 mw-95 mw-sm-75 mw-md-50 mw-lg-none mx-auto">
                {% block "score_table" %}
                <table class="scorecard-table js-previous-year-score-difference-table" has-difference="true">
                    <thead class="position-sticky top-0 z-index-4">
                        <tr class="first-row position-sticky bg-white z-index-5">
                            <th scope="col" class="bg-light position-sticky z-index-4 pb-1">
                                <div class="ms-4">
                                    <h2 class="mb-1 fs-5 lh-1">{{ authority_type_label }}</h2>
                                    <p class="mb-0 fs-8">Council Climate Action Scorecard</p>
                                </div>
                            </th>
                            {% if previous_year %}
                            <th scope="col" colspan="2" class="total-score js-previous-year-difference-header position-sticky pb-1 z-index-2">
                            {% else %}
                            <th scope="col" colspan="1" class="total-score js-previous-year-difference-header position-sticky pb-1 z-index-2">
                            {% endif %}
                                <div class="section-title">
                                    <span class="text-center fw-bold">Total Score</span>
                                    <button class="js-sort-table btn btn-outline-primary sort-icon align-items-start {% if sorted_by is None %} is-sorted-descending{% endif %}" title="Sort lowest first" data-sort-default="descending"></button>
                                </div>
                            </th>

                            {% for section in section_averages %}
                                {% if previous_year %}
                                    <th scope="col" colspan="2" class="pb-1 js-previous-year-difference-header">
                                {% else %}
                                    <th scope="col" colspan="1" class="pb-1 js-previous-year-difference-header">
                                {% endif %}
                                    <div class="section-title">
                                        {% include section_link_template with section_code=section.code section_name=section.title category_number=forloop.counter %}
                                        <button class="js-sort-table btn btn-outline-primary sort-icon align-items-start is--category-1 {% if sorted_by == section.code %} is-sorted-descending{% endif %}" title="Sort highest first"></button>
                                    </div>
                                </th>
                            {% endfor %}
                        </tr>
                        {% if previous_year %}
                        <tr class="js-previous-year-score-difference">
                            <th class="h-auto pb-2 pt-0 bg-white position-sticky"></th>
                            <th scope="col" class="h-auto pb-2 pt-0 fs-8 text-center total-score position-sticky">{{ plan_year }}</th>
                            <th scope="col" class="h-auto pb-2 pt-0 fs-8 previous-year-score-difference text-center position-sticky">versus {{ previous_year.year }}</th>

                            {% for x in section_averages %}
                                <th scope="col" class="h-auto pb-2 pt-0 fs-8 text-center total-score">{{ plan_year }}</th>
                                <th scope="col" class="h-auto pb-2 pt-0 fs-8 previous-year-score-difference text-center position-static">versus {{ previous_year.year }}</th>
                            {% endfor %}
                        </tr>
                        {% endif %}
                        <tr class="second-row position-sticky z-index-4">
                            <th scope="col" class="bg-primary-100 position-sticky z-index-4">
                                <span class="ms-4 fs-6 fw-bold d-block">{{ scoring_group.name }} average</span>
                            </th>
                            <th scope="col" class="bg-primary-100 total-score position-sticky z-index-4">
                                {% include 'scoring/includes/score-bar.html' with percentage=averages.total.percentage average=1 %}
                            </th>
                            {% if previous_year %}
                                {% include 'scoring/includes/fp_header_integer_score_change.html' with change=averages.total.change %}
                            {% endif %}

                            {% for section in section_averages %}
                                <th scope="col" class="bg-primary-100 category-{{ forloop.counter }} second-row">
                                    {% include 'scoring/includes/score-bar.html' with percentage=section.weighted average=1 %}
                                </th>
                                {% if previous_year %}
                                    {% include 'scoring/includes/fp_header_integer_score_change.html' with change=section.change %}
                                {% endif %}
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                      {% for council in council_data %}
                        <tr data-jump-slug="{{ council.slug }}">
                            <th scope="row" class="first-column position-sticky z-index-3 align-middle">
                                <div class="d-flex flex-row align-items-center">
                                    {% if council.top_performer %}
                                        <button class="bg-transparent border-0" type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="Top performer council">
                                            {% include 'caps/icons/scorecards-star.html' with classes='text-info align-text-top' width='1.2em' height='1.2em' %}
                                        </button>
                                    {% else %}
                                        <div class="pe-4"></div>
                                    {% endif %}
                                    {% include council_link_template with plan_year=plan_year council=council %}
                                </div>
                            </th>
                            <th scope="row" class="council-category-score total-score fw-bold position-sticky z-index-3 align-middle" data-sort-value="{{ council.percentage|default:"0" }}">
                                {% include 'scoring/includes/score-bar.html' with percentage=council.percentage %}
                            </th>
                            {% if previous_year %}
                                {% include 'scoring/includes/fp_integer_score_change.html' with change=council.change %}
                            {% endif %}
                          {% with scores=council.all_scores %}
                          {% if council.score != 0 and council.score is not None %}
                            {% for score in scores %}
                            <td scope="row" class="council-category-score category-{{ forloop.counter }}" data-sort-value="{{ score.score|default:"0" }}">
                                    <div class="score-bar">
                                      {% if sort %}
                                        <div class="sort-icon"></div>
                                      {% endif %}
                                      <span class="score-percentage">{{ score.weighted|floatformat:"0" }}%</span>
                                      <div class="progress-bar" style="width: {{ score.weighted }}%;"></div>
                                    </div>
                                </td>
                                {% if previous_year %}
                                    {% if score.change < 0 %}
                                        <td scope="row" class="display-only-large-up js-previous-year-score-difference previous-year-score-difference text-warning position-static">&#9660; {{ score.change }}</td>
                                    {% elif score.change > 0 %}
                                        <td scope="row" class="display-only-large-up js-previous-year-score-difference previous-year-score-difference text-success position-static">&#9650; {{ score.change }}</td>
                                    {% elif score.change == 0 %}
                                        <td scope="row" class="display-only-large-up js-previous-year-score-difference previous-year-score-difference position-static">--</td>
                                    {% else %}
                                        <td scope="row" class="display-only-large-up js-previous-year-score-difference previous-year-score-difference position-static">NA</td>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                          {% elif council.score == 0 %}
                            <td class="has-no-plan" colspan="7" data-sort-value="-1">
                                Not scored: newly formed council since April 2023. This council will be assessed in future Scorecard editions.
                            </td>
                          {% for x in "123456" %}
                            <td scope="row" data-sort-value="-1" hidden></td>
                          {% endfor %}
                          {% elif council.score is None %}
                            <td class="has-no-plan" colspan="7" data-sort-value="-1">
                                Due to technical issues, this council’s results are not yet available. They will be published soon.
                            </td>
                          {% for x in "123456" %}
                            <td scope="row" data-sort-value="-1" hidden></td>
                          {% endfor %}
                          {% endif %}
                          {% endwith %}
                        </tr>
                      {% endfor %}
                    </tbody>
                </table>

                {% comment %} Council Jump mobile {% endcomment %}
                <div class="bg-gray-200 px-3 py-2 d-lg-none border-top">
                    {% include 'scoring/includes/jump-to-council.html' %}
                </div>

                {% comment %} Category select for mobile {% endcomment %}
                <form role="search" class="d-lg-none position-sticky top-0 z-index-3 pt-3 px-3">
                    <label class="visually-hidden" for="mobile-category-select">Select category</label>
                    <select id="mobile-category-select" name="category" aria-label="Select category" class="form-select fw-bold js-category-select">
                        <option value="js-total" selected>Total Score</option>
                        {% for section in section_averages %}
                        <option value="js-{{ section.code }}">{{ section.title }}</option>
                        {% endfor %}
                    </select>
                </form>

                <div class="visually-hidden js-category-select-announcement" aria-live="polite">Now showing Total Score</div>

                <div class="overflow-auto" style="max-height: 70dvh">
                    <table class="scorecard-table-mobile js-category-select-table w-100">
                        <thead class="border-bottom border-dark border-opacity-25">
                            <tr class="name-row">
                                <th class="fw-bold" scope="row" colspan="4">{{ scoring_group.name }} average</th>
                            </tr>
                            {% if previous_year %}
                            <tr class="legend-row fs-8">
                                <th></th>
                                <th scope="col" class="fw-normal">{{ plan_year }}</th>
                                <th scope="col" class="fw-normal">versus {{ previous_year.year }}</th>
                                <th></th>
                            </tr>
                            {% endif %}
                            <tr class="score-row js-score-row js-total">
                                <td class="spacer-cell" aria-hidden="true"><span class="d-none"></span></td>
                                <td>
                                    {% include 'scoring/includes/score-bar.html' with percentage=averages.total.percentage average=1 %}
                                </td>
                                {% if previous_year %}
                                <td>
                                    {% if averages.total.change < 0 %}
                                        <span class="badge bg-red-100 text-warning">&#9660; {{ averages.total.change }}</span>
                                    {% elif averages.total.change > 0 %}
                                        <span class="badge bg-green-100 text-success">&#9650; {{ averages.total.change }}</span>
                                    {% elif averages.total.change == 0 %}
                                        <span class="badge bg-gray-100">-- 0</span>
                                    {% else %}
                                        <span class="badge bg-gray-100">NA</span>
                                    {% endif %}
                                </td>
                                {% endif %}
                                <td class="spacer-cell" aria-hidden="true"><span class="d-none"></span></td>
                            </tr>
                            {% for section in section_averages %}
                            <tr class="score-row js-score-row js-score-row-initial-hidden js-{{ section.code }} category-{{ forloop.counter }}">
                                <td class="spacer-cell" aria-hidden="true"><span class="d-none"></span></td>
                                <td>
                                    {% include 'scoring/includes/score-bar.html' with percentage=section.weighted average=1 %}
                                </td>
                                {% if previous_year %}
                                <td>
                                {% if section.change < 0 %}
                                    <span class="badge bg-red-100 text-warning">&#9660; {{ section.change }}</span>
                                {% elif section.change > 0 %}
                                    <span class="badge bg-green-100 text-success">&#9650; {{ section.change }}</span>
                                {% elif section.change == 0 %}
                                    <span class="badge bg-gray-100">-- 0</span>
                                {% else %}
                                    <span class="badge bg-gray-100">NA</span>
                                {% endif %}
                                </td>
                                {% endif %}
                                </td>
                                <td class="spacer-cell" aria-hidden="true"><span class="d-none"></span></td>
                            </tr>
                            {% endfor %}
                        </thead>

                        <tbody>
                            {% for council in council_data %}
                                <tr class="name-row" data-jump-slug="{{ council.slug }}">
                                    <th class="fw-normal" scope="row" colspan="4">
                                        {% if council.top_performer %}
                                        <div class="d-flex align-items-center justify-content-center">
                                            <button class="bg-transparent border-0" type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="Top performer council">
                                                {% include 'caps/icons/scorecards-star.html' with classes='text-info align-text-top' width='1.2em' height='1.2em' %}
                                            </button>
                                            {% endif %}
                                            <a class="lh-base council-link d-flex align-items-center justify-content-center" href="{% url 'scoring:council' council.slug %}">
                                                <span>{{ council.name }}</span>
                                                {% include 'caps/icons/link.html' with classes='align-text-top ms-1' width='1em' height='auto' role='presentation' %}
                                            </a>
                                        </div>
                                    </th>
                                </tr>
                                <tr class="score-row js-score-row js-total">
                                    <td class="spacer-cell" aria-hidden="true"><span class="d-none"></span></td>
                                    <td>
                                        {% if council.score != 0 %}
                                            {% include 'scoring/includes/score-bar.html' with percentage=averages.total.percentage average=1 %}
                                        {% else %}
                                            <span>--</span>
                                        {% endif %}
                                    </td>
                                    {% if previous_year %}
                                    <td>
                                        {% if council.change < 0 %}
                                        <span class="badge bg-red-100 text-warning">&#9660; {{ council.change }}</span>
                                        {% elif council.change > 0 %}
                                            <span class="badge bg-green-100 text-success">&#9650; {{ council.change }}</span>
                                        {% elif council.change == 0 %}
                                            <span class="badge bg-gray-100">-- 0</span>
                                        {% else %}
                                            <span class="badge bg-gray-100">NA</span>
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                    <td class="spacer-cell" aria-hidden="true"><span class="d-none"></span></td>
                                </tr>

                                {% if council.score == 0 %}
                                <tr class="message-row">
                                    {% comment %} TODO update current year message {% endcomment %}
                                    <td colspan="4"><span class="small" style="white-space:normal">This council did not have an action plan when all plans were assessed on 20th September 2021.</span></td>
                                </tr>
                                {% endif %}

                                {% comment %} TODO message for previous year {% endcomment %}
                                {% if council.score == 0 %}
                                <tr class="message-row">
                                    <td colspan="4"><span class="small" style="white-space:normal">This council did not have an action plan when all plans were assessed on 20th September 2021.</span></td>
                                </tr>
                                {% endif %}

                                {% with scores=council.all_scores %}
                                    {% if council.score != 0 and council.score is not None %}
                                        {% for score in scores %}
                                        <tr class="score-row js-score-row js-score-row-initial-hidden js-{{ score.code }}">
                                            <td class="spacer-cell" aria-hidden="true"><span class="d-none"></span></td>
                                            <td class="council-category-score category-{{ forloop.counter }}">
                                                <div class="score-bar">
                                                  {% if sort %}
                                                    <div class="sort-icon"></div>
                                                  {% endif %}
                                                  <span class="score-percentage">{{ score.weighted|floatformat:"0" }}%</span>
                                                  <div class="progress-bar" style="width: {{ score.weighted }}%;"></div>
                                                </div>
                                            </td>
                                            {% if previous_year %}
                                            <td>
                                                {% if score.change < 0 %}
                                                <span class="badge bg-red-100 text-warning">&#9660; {{ score.change }}</span>
                                                {% elif score.change > 0 %}
                                                    <span class="badge bg-green-100 text-success">&#9650; {{ score.change }}</span>
                                                {% elif score.change == 0 %}
                                                    <span class="badge bg-gray-100">-- 0</span>
                                                {% else %}
                                                    <span class="badge bg-gray-100">NA</span>
                                                {% endif %}
                                            </td>
                                            {% endif %}
                                            <td class="spacer-cell" aria-hidden="true"><span class="d-none"></span></td>
                                        </tr>
                                        {% endfor %}
                                    {% elif council.score == 0 %}
                                        <tr class="message-row">
                                            {% comment %} TODO update current year message {% endcomment %}
                                            <td colspan="4"><span class="small" style="white-space:normal">Not scored: newly formed council since April 2023. This council will be assessed in future Scorecard editions.</span></td>
                                            {% for x in "123456" %}
                                                <td scope="row" data-sort-value="-1" hidden></td>
                                            {% endfor %}
                                        </tr>
                                    {% elif council.score is None %}
                                        <tr class="message-row">
                                            {% comment %} TODO update current year message {% endcomment %}
                                            <td colspan="4"><span class="small" style="white-space:normal">Due to technical issues, this council’s results are not yet available. They will be published soon.</span></td>
                                            {% for x in "123456" %}
                                                <td scope="row" data-sort-value="-1" hidden></td>
                                            {% endfor %}
                                        </tr>
                                    {% endif %}
                                {% endwith %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                {% endblock %}
            </div>

            <p class="mt-4 mt-lg-5 mb-0">
                <a href="https://climateemergency.uk/council-climate-action-scorecards-data-packages/" class="cta mx-auto">Click here</a> to buy the data that is available on this website in spreadsheet (.csv) format.
            </p>
        </div>    
    </div>

{% endblock %}
